name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Prepare build directory
        run: |
          mkdir build
          rsync -av --exclude='build' --exclude='.github' ./ build/

      - name: Rewrite absolute paths for GitHub Pages
        run: |
          echo "=== BEFORE REWRITE ==="
          grep -R '="/js/' -n build || true
          grep -R '="/css/' -n build || true

          # HTML: CSS
          find build -type f -name "*.html" -exec sed -i 's|href="/css/|href="/cvforge/css/|g' {} +
          find build -type f -name "*.html" -exec sed -i 's|src="/css/|src="/cvforge/css/|g' {} +

          # HTML: JS
          find build -type f -name "*.html" -exec sed -i 's|href="/js/|href="/cvforge/js/|g' {} +
          find build -type f -name "*.html" -exec sed -i 's|src="/js/|src="/cvforge/js/|g' {} +

          # JS module imports
          find build -type f -name "*.js" -exec sed -i 's|from "/js/|from "/cvforge/js/|g' {} +

          # CSS url()
          find build -type f -name "*.css" -exec sed -i 's|url(/|url(/cvforge/|g' {} +

          echo "=== AFTER REWRITE ==="
          grep -R '/cvforge/js/' -n build || true
          grep -R '/cvforge/css/' -n build || true

      - name: Force unique commit (avoid GitHub Pages caching)
        run: |
          date +%s > build/.deploy-timestamp

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build
          publish_branch: gh-pages
